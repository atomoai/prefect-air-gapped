name: Release Air-gapped Version

on:
  push:
    tags:
      - 'air-gapped-*'
  workflow_dispatch:

jobs:
  build-test:
    name: Build and test Docker image
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Only run on tags if they match the air-gapped pattern
    if: |
      github.event_name != 'push' ||
      !startsWith(github.ref, 'refs/tags/') ||
      startsWith(github.ref, 'refs/tags/air-gapped-')

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get Node version
        id: node_version
        run: |
          echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_OUTPUT

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64
          build-args: |
            PYTHON_VERSION=3.12
            NODE_VERSION=${{ steps.node_version.outputs.NODE_VERSION }}
          tags: prefect-air-gapped:test
          push: false
          load: true
          cache-from: type=gha,scope=test-build
          cache-to: type=gha,mode=max,scope=test-build

      - name: Test image - basic commands
        run: |
          echo "ðŸ§ª Testing basic Prefect commands..."
          echo ""

          echo "âœ“ Testing prefect version..."
          docker run --rm prefect-air-gapped:test prefect version

          echo ""
          echo "âœ“ Testing prefect --help..."
          docker run --rm prefect-air-gapped:test prefect --help

          echo ""
          echo "âœ“ Testing Python import..."
          docker run --rm prefect-air-gapped:test python -c "import prefect; print(f'Prefect {prefect.__version__}')"

      - name: Verify version matches tag
        if: startsWith(github.ref, 'refs/tags/air-gapped-')
        run: |
          echo "ðŸ” Verifying version matches tag..."
          echo ""

          # Extract version from tag (remove 'air-gapped-' prefix)
          TAG_VERSION="${GITHUB_REF#refs/tags/air-gapped-}"
          echo "Expected version from tag: ${TAG_VERSION}"

          # Get version from docker image
          IMAGE_VERSION=$(docker run --rm prefect-air-gapped:test prefect version | grep -oP 'Version:\s+\K[\d.]+')
          echo "Image version: ${IMAGE_VERSION}"

          # Compare versions
          if [ "${TAG_VERSION}" = "${IMAGE_VERSION}" ]; then
            echo "âœ… Version matches tag!"
          else
            echo "âŒ Version mismatch!"
            echo "   Tag version: ${TAG_VERSION}"
            echo "   Image version: ${IMAGE_VERSION}"
            exit 1
          fi



      - name: Log in to Docker Hub
        if: startsWith(github.ref, 'refs/tags/air-gapped-')
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Publish image to Docker Hub
        if: startsWith(github.ref, 'refs/tags/air-gapped-')
        run: |
          set -euo pipefail

          # Destination repository on Docker Hub, e.g. "myuser/prefect-air-gapped"
          DEST_REPO="${{ vars.DOCKERHUB_REPO }}"
          if [ -z "${DEST_REPO}" ]; then
            echo "Repository variable DOCKERHUB_REPO is not set (e.g. myuser/prefect-air-gapped)."
            exit 1
          fi

          # Extract version from tag (remove 'air-gapped-' prefix)
          TAG_VERSION="${GITHUB_REF#refs/tags/air-gapped-}"

          echo "ðŸ” Authenticated to Docker Hub"
          echo "ðŸš€ Publishing image ${DEST_REPO}:${TAG_VERSION}"

          # Reuse the already built and tested image by retagging and pushing
          docker tag prefect-air-gapped:test "${DEST_REPO}:${TAG_VERSION}"
          docker push "${DEST_REPO}:${TAG_VERSION}"

          echo "âœ… Published ${DEST_REPO}:${TAG_VERSION}"


      - name: Build summary
        run: |
          echo "### âœ… Docker Build Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** prefect-air-gapped:test" >> $GITHUB_STEP_SUMMARY
          echo "**Python:** 3.12" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** linux/amd64" >> $GITHUB_STEP_SUMMARY

          # Add version info if triggered by tag
          if [[ "$GITHUB_REF" == refs/tags/air-gapped-* ]]; then
            TAG_VERSION="${GITHUB_REF#refs/tags/air-gapped-}"
            echo "**Tag Version:** ${TAG_VERSION}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Version verification passed" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ vars.DOCKERHUB_REPO }}" ]; then
              echo "**Published To:** docker.io/${{ vars.DOCKERHUB_REPO }}:${TAG_VERSION}" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All basic functionality tests passed." >> $GITHUB_STEP_SUMMARY
