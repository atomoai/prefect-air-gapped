name: Release Air-gapped Version

on:
  push:
    tags:
      - 'air-gapped-*'
  workflow_dispatch:

jobs:
  build-test:
    name: Build and test Docker image
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Only run on tags if they match the air-gapped pattern
    if: |
      github.event_name != 'push' ||
      !startsWith(github.ref, 'refs/tags/') ||
      startsWith(github.ref, 'refs/tags/air-gapped-')
    outputs:
      version: ${{ steps.extract_version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get Node version
        id: node_version
        run: |
          echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_OUTPUT

      - name: Extract version from tag
        id: extract_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/air-gapped-* ]]; then
            VERSION="${GITHUB_REF#refs/tags/air-gapped-}"
          else
            # For workflow_dispatch, use a test version
            VERSION="test"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION}"

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64
          build-args: |
            PYTHON_VERSION=3.12
            NODE_VERSION=${{ steps.node_version.outputs.NODE_VERSION }}
          tags: prefect-air-gapped:${{ steps.extract_version.outputs.version }}
          push: false
          load: true
          cache-from: type=gha,scope=test-build
          cache-to: type=gha,mode=max,scope=test-build

      - name: Test image - basic commands
        run: |
          echo "ðŸ§ª Testing basic Prefect commands..."
          echo ""

          echo "âœ“ Testing prefect version..."
          docker run --rm prefect-air-gapped:${{ steps.extract_version.outputs.version }} prefect version

          echo ""
          echo "âœ“ Testing prefect --help..."
          docker run --rm prefect-air-gapped:${{ steps.extract_version.outputs.version }} prefect --help

          echo ""
          echo "âœ“ Testing Python import..."
          docker run --rm prefect-air-gapped:${{ steps.extract_version.outputs.version }} python -c "import prefect; print(f'Prefect {prefect.__version__}')"

      - name: Verify version matches tag
        if: startsWith(github.ref, 'refs/tags/air-gapped-')
        run: |
          echo "ðŸ” Verifying version matches tag..."
          echo ""

          TAG_VERSION="${{ steps.extract_version.outputs.version }}"
          echo "Expected version from tag: ${TAG_VERSION}"

          # Get version from docker image
          IMAGE_VERSION=$(docker run --rm prefect-air-gapped:${{ steps.extract_version.outputs.version }} prefect version | grep -oP 'Version:\s+\K[\d.]+')
          # Trim trailing periods and whitespace
          IMAGE_VERSION=$(echo "${IMAGE_VERSION}" | sed 's/[. ]*$//')
          echo "Image version: ${IMAGE_VERSION}"

          # Compare versions
          if [ "${TAG_VERSION}" = "${IMAGE_VERSION}" ]; then
            echo "âœ… Version matches tag!"
          else
            echo "âŒ Version mismatch!"
            echo "   Tag version: ${TAG_VERSION}"
            echo "   Image version: ${IMAGE_VERSION}"
            exit 1
          fi

      - name: Build summary
        run: |
          echo "### âœ… Phase 1: Build Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** prefect-air-gapped:${{ steps.extract_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Python:** 3.12" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** linux/amd64" >> $GITHUB_STEP_SUMMARY

          # Add version info if triggered by tag
          if [[ "$GITHUB_REF" == refs/tags/air-gapped-* ]]; then
            TAG_VERSION="${{ steps.extract_version.outputs.version }}"
            echo "**Tag Version:** ${TAG_VERSION}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Version verification passed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All basic functionality tests passed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âž¡ï¸ Proceeding to Phase 2: Multi-variant build and publish" >> $GITHUB_STEP_SUMMARY

  publish-matrix:
    name: Publish multi-variant images
    needs: build-test
    runs-on: ubuntu-latest
    timeout-minutes: 60
    # Only publish on tags
    if: startsWith(github.ref, 'refs/tags/air-gapped-')
    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Get Node version
        id: node_version
        run: |
          echo "NODE_VERSION=$(cat .nvmrc)" >> $GITHUB_OUTPUT

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64
          build-args: |
            PYTHON_VERSION=${{ matrix.python-version }}
            NODE_VERSION=${{ steps.node_version.outputs.NODE_VERSION }}
          tags: ${{ vars.DOCKERHUB_REPO }}:${{ needs.build-test.outputs.version }}-python${{ matrix.python-version }}
          push: true
          pull: true
          provenance: false
          cache-from: type=gha,scope=air-gapped-${{ matrix.python-version }},ignore-error=true
          cache-to: type=gha,mode=max,scope=air-gapped-${{ matrix.python-version }},ignore-error=true

      - name: Build summary
        run: |
          echo "### âœ… Published: ${{ vars.DOCKERHUB_REPO }}:${{ needs.build-test.outputs.version }}-python${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Python:** ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** linux/amd64" >> $GITHUB_STEP_SUMMARY
